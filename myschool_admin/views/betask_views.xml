<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- ========================================= -->
    <!-- BACKEND TASK VIEWS -->
    <!-- ========================================= -->

    <!-- List View -->
    <record id="view_betask_list" model="ir.ui.view">
        <field name="name">myschool.betask.list</field>
        <field name="model">myschool.betask</field>
        <field name="arch" type="xml">
            <list string="Backend Tasks" 
                  decoration-danger="status == 'error'" 
                  decoration-success="status == 'completed_ok'" 
                  decoration-info="status == 'processing'"
                  decoration-muted="not active">
                <field name="name"/>
                <field name="betasktype_id"/>
                <field name="target" widget="badge" optional="show"/>
                <field name="object_type" widget="badge" optional="show"/>
                <field name="action" widget="badge" optional="show"/>
                <field name="status" widget="badge" 
                       decoration-success="status == 'completed_ok'" 
                       decoration-info="status == 'processing'" 
                       decoration-danger="status == 'error'" 
                       decoration-muted="status == 'new'"/>
                <field name="automatic_sync" widget="boolean_toggle"/>
                <field name="retry_count" optional="hide"/>
                <field name="create_date" string="Created"/>
                <field name="lastrun" string="Last Run" optional="show"/>
                <field name="changes" string="Applied Changes" optional="hide"/>
                <field name="error_description" optional="hide"/>
                <field name="active" column_invisible="1"/>
            </list>
        </field>
    </record>

    <!-- Form View -->
    <record id="view_betask_form" model="ir.ui.view">
        <field name="name">myschool.betask.form</field>
        <field name="model">myschool.betask</field>
        <field name="arch" type="xml">
            <form string="Backend Task">
                <header>
                    <button name="action_process_single" 
                            string="Process Now" 
                            type="object" 
                            class="oe_highlight"
                            invisible="status not in ['new', 'error']"/>
                    <button name="action_set_processing" 
                            string="Set Processing" 
                            type="object" 
                            invisible="status != 'new'"/>
                    <button name="action_set_completed" 
                            string="Mark Completed" 
                            type="object" 
                            class="btn-success"
                            invisible="status not in ['new', 'processing']"/>
                    <button name="action_set_error" 
                            string="Mark Error" 
                            type="object" 
                            class="btn-warning"
                            invisible="status not in ['new', 'processing']"/>
                    <button name="action_reset_to_new" 
                            string="Retry" 
                            type="object" 
                            invisible="status != 'error'"/>
                    <button name="action_force_reset" 
                            string="Force Reset" 
                            type="object" 
                            class="btn-secondary"
                            invisible="status not in ['error', 'completed_ok']"
                            groups="base.group_system"/>
                    <field name="status" widget="statusbar" statusbar_visible="new,processing,completed_ok"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="action_view_sys_events"
                                type="object"
                                class="oe_stat_button"
                                icon="fa-calendar">
                            <span>Related Events</span>
                        </button>
                    </div>
                    <widget name="web_ribbon" title="Archived" bg_color="text-bg-danger" invisible="active"/>
                    <widget name="web_ribbon" title="ERROR" bg_color="text-bg-danger" invisible="status != 'error'"/>
                    <div class="oe_title">
                        <h1>
                            <field name="name" readonly="1"/>
                        </h1>
                    </div>
                    <group>
                        <group string="Task Information">
                            <field name="betasktype_id"/>
                            <field name="target" readonly="1"/>
                            <field name="object_type" readonly="1"/>
                            <field name="action" readonly="1"/>
                            <field name="automatic_sync" widget="boolean_toggle"/>
                        </group>
                        <group string="Status &amp; Tracking">
                            <field name="status" readonly="1"/>
                            <field name="retry_count"/>
                            <field name="max_retries"/>
                            <field name="user_id" readonly="1"/>
                            <field name="processed_by_id" readonly="1"/>
                            <field name="active" widget="boolean_toggle"/>
                        </group>
                    </group>
                    <group>
                        <group string="Timing">
                            <field name="create_date" readonly="1"/>
                            <field name="processing_start" readonly="1"/>
                            <field name="processing_end" readonly="1"/>
                            <field name="lastrun" readonly="1"/>
                            <field name="processing_duration" readonly="1" invisible="not processing_duration"/>
                        </group>
                        <group string="Company">
                            <field name="company_id" groups="base.group_multi_company"/>
                        </group>
                    </group>
                    <notebook>
                        <page string="Data" name="data">
                            <group>
                                <field name="data" widget="ace" options="{'mode': 'json'}" placeholder="Primary task data (JSON)..."/>
                            </group>
                            <group>
                                <field name="data2" widget="ace" options="{'mode': 'json'}" placeholder="Secondary task data (JSON)..."/>
                            </group>
                        </page>
                        <page string="Applied Changes" name="changes" invisible="not changes">
                            <group>
                                <field name="changes" readonly="1" nolabel="1"/>
                            </group>
                        </page>
                        <page string="Error" name="error" invisible="not error_description">
                            <group>
                                <field name="error_description" readonly="1"/>
                            </group>
                        </page>
                    </notebook>
                </sheet>
                <chatter/>
            </form>
        </field>
    </record>

    <!-- Kanban View -->
    <record id="view_betask_kanban" model="ir.ui.view">
        <field name="name">myschool.betask.kanban</field>
        <field name="model">myschool.betask</field>
        <field name="arch" type="xml">
            <kanban class="o_kanban_mobile" default_group_by="status">
                <field name="name"/>
                <field name="betasktype_id"/>
                <field name="status"/>
                <field name="color"/>
                <field name="automatic_sync"/>
                <field name="create_date"/>
                <field name="lastrun"/>
                <field name="retry_count"/>
                <progressbar field="status" colors='{"new": "muted", "processing": "info", "error": "danger", "completed_ok": "success"}'/>
                <templates>
                    <t t-name="kanban-box">
                        <div t-attf-class="oe_kanban_color_#{kanban_getcolor(record.color.raw_value)} oe_kanban_card oe_kanban_global_click">
                            <div class="o_kanban_record_top">
                                <div class="o_kanban_record_headings">
                                    <strong class="o_kanban_record_title">
                                        <field name="name"/>
                                    </strong>
                                </div>
                                <span t-if="record.retry_count.raw_value > 0" class="badge text-bg-warning">
                                    Retry: <field name="retry_count"/>
                                </span>
                            </div>
                            <div class="o_kanban_record_body">
                                <field name="betasktype_id"/>
                                <div class="mt-1">
                                    <span t-if="record.automatic_sync.raw_value" class="badge text-bg-info">Auto</span>
                                    <span t-else="" class="badge text-bg-secondary">Manual</span>
                                </div>
                            </div>
                            <div class="o_kanban_record_bottom">
                                <div class="oe_kanban_bottom_left">
                                    <field name="create_date" widget="date"/>
                                </div>
                                <div class="oe_kanban_bottom_right">
                                    <span t-if="record.lastrun.raw_value" class="text-muted">
                                        Last: <field name="lastrun" widget="date"/>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- Search View -->
    <record id="view_betask_search" model="ir.ui.view">
        <field name="name">myschool.betask.search</field>
        <field name="model">myschool.betask</field>
        <field name="arch" type="xml">
            <search string="Search Tasks">
                <field name="name"/>
                <field name="betasktype_id"/>
                <field name="data"/>
                <field name="changes"/>
                <field name="error_description"/>
                <separator/>
                <!-- Status Filters -->
                <filter string="New" name="new" domain="[('status', '=', 'new')]"/>
                <filter string="Processing" name="processing" domain="[('status', '=', 'processing')]"/>
                <filter string="Completed" name="completed" domain="[('status', '=', 'completed_ok')]"/>
                <filter string="Error" name="error" domain="[('status', '=', 'error')]"/>
                <filter string="Pending (New + Error)" name="pending" domain="[('status', 'in', ['new', 'error'])]"/>
                <separator/>
                <filter string="Auto Sync" name="auto_sync" domain="[('automatic_sync', '=', True)]"/>
                <filter string="Manual Only" name="manual_sync" domain="[('automatic_sync', '=', False)]"/>
                <separator/>
                <!-- Target Filters -->
                <filter string="Database" name="target_db" domain="[('target', '=', 'DB')]"/>
                <filter string="LDAP" name="target_ldap" domain="[('target', '=', 'LDAP')]"/>
                <filter string="All Systems" name="target_all" domain="[('target', '=', 'ALL')]"/>
                <separator/>
                <!-- Date Filters -->
                <filter string="Created Today" name="today" 
                        domain="[('create_date', '&gt;=', datetime.datetime.combine(context_today(), datetime.time(0,0,0)).strftime('%%Y-%%m-%%d %%H:%%M:%%S'))]"/>
                <filter string="Created This Week" name="week" 
                        domain="[('create_date', '&gt;=', (context_today() - datetime.timedelta(days=7)).strftime('%%Y-%%m-%%d'))]"/>
                <separator/>
                <filter string="Active" name="active" domain="[('active', '=', True)]"/>
                <filter string="Archived" name="inactive" domain="[('active', '=', False)]"/>
            </search>
        </field>
    </record>

    <!-- ========================================= -->
    <!-- ACTIONS -->
    <!-- ========================================= -->

    <!-- All Tasks -->
    <record id="action_betask_all" model="ir.actions.act_window">
        <field name="name">All Tasks</field>
        <field name="res_model">myschool.betask</field>
        <field name="view_mode">list,kanban,form</field>
        <field name="context">{'search_default_active': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No backend tasks found
            </p>
            <p>
                Backend tasks are created by sync processes and other system operations.
                They are processed automatically by scheduled jobs or manually.
            </p>
        </field>
    </record>

    <!-- Pending Tasks -->
    <record id="action_betask_pending" model="ir.actions.act_window">
        <field name="name">Pending Tasks</field>
        <field name="res_model">myschool.betask</field>
        <field name="view_mode">list,kanban,form</field>
        <field name="context">{'search_default_pending': 1}</field>
        <field name="domain">[('status', 'in', ['new', 'error'])]</field>
    </record>

    <!-- Error Tasks -->
    <record id="action_betask_errors" model="ir.actions.act_window">
        <field name="name">Error Tasks</field>
        <field name="res_model">myschool.betask</field>
        <field name="view_mode">list,kanban,form</field>
        <field name="context">{'search_default_error': 1}</field>
        <field name="domain">[('status', '=', 'error')]</field>
    </record>

    <!-- Processing Tasks -->
    <record id="action_betask_processing" model="ir.actions.act_window">
        <field name="name">Processing Tasks</field>
        <field name="res_model">myschool.betask</field>
        <field name="view_mode">list,kanban,form</field>
        <field name="context">{'search_default_processing': 1}</field>
        <field name="domain">[('status', '=', 'processing')]</field>
    </record>

</odoo>
