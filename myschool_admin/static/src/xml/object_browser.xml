<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">

    <!-- Context Menu Template -->
    <t t-name="myschool_admin.ContextMenu" owl="1">
        <div class="ob-context-menu" t-att-style="'left: ' + props.x + 'px; top: ' + props.y + 'px;'">
            <div class="ob-context-menu-header">
                <t t-esc="props.node.name"/>
            </div>
            <t t-foreach="menuItems" t-as="item" t-key="item.action || item_index">
                <t t-if="item.divider">
                    <div class="ob-context-menu-divider"/>
                </t>
                <t t-else="">
                    <div class="ob-context-menu-item" 
                         t-att-class="{ 'ob-context-menu-item-danger': item.danger }"
                         t-on-click="onMenuItemClick"
                         t-att-data-action="item.action">
                        <i t-att-class="item.iconClass" style="margin-right: 8px; width: 18px;"/>
                        <t t-esc="item.label"/>
                    </div>
                </t>
            </t>
        </div>
    </t>

    <!-- Tree Node Template -->
    <t t-name="myschool_admin.TreeNode" owl="1">
        <div class="ob-node" 
             t-att-style="'padding-left: ' + (level * 12) + 'px;'"
             t-att-class="{ 'ob-node-dragging': isDragging, 'ob-node-drag-over': state.dragOver, 'ob-node-active': isActiveNode }"
             draggable="true"
             t-on-dragstart="onDragStart"
             t-on-dragover="onDragOver"
             t-on-dragleave="onDragLeave"
             t-on-drop="onDrop"
             t-on-dragend="onDragEnd"
             t-on-contextmenu="onContextMenu">
            <!-- Node Row -->
            <div class="ob-row" t-att-class="{ 'ob-row-expandable': hasChildren, 'ob-row-selected': isSelected }" t-on-click="onRowClick">
                <!-- Checkbox for selection mode -->
                <t t-if="props.selectedIds">
                    <input type="checkbox" 
                           class="ob-checkbox-select"
                           t-att-checked="isSelected"
                           t-on-change="onCheckboxChange"
                           t-on-click.stop=""/>
                </t>
                
                <!-- Toggle Button -->
                <t t-if="hasChildren">
                    <span class="ob-toggle" t-on-click.stop="toggle">
                        <i t-att-class="state.expanded ? 'fa fa-caret-down' : 'fa fa-caret-right'"/>
                    </span>
                </t>
                <t t-else="">
                    <span class="ob-toggle ob-toggle-empty"></span>
                </t>
                
                <!-- Icon -->
                <span class="ob-icon">
                    <t t-if="props.node.type === 'org'">
                        <i class="fa fa-building text-primary"/>
                    </t>
                    <t t-elif="props.node.type === 'person'">
                        <i class="fa fa-user text-info"/>
                    </t>
                    <t t-else="">
                        <i class="fa fa-file"/>
                    </t>
                </span>
                
                <!-- Name with tooltip showing full name -->
                <span class="ob-name" t-att-title="displayTitle">
                    <t t-esc="props.node.name"/>
                </span>
                
                <!-- Badges -->
                <span class="ob-badges">
                    <t t-if="props.node.is_administrative">
                        <span class="ob-badge ob-badge-admin">ADM</span>
                    </t>
                    <t t-if="props.node.person_count">
                        <span class="ob-badge ob-badge-success">
                            <t t-esc="props.node.person_count"/>
                        </span>
                    </t>
                </span>
            </div>
            
            <!-- Children (if expanded) -->
            <t t-if="state.expanded and hasChildren">
                <div class="ob-children">
                    <!-- Child Organizations -->
                    <t t-if="props.node.children">
                        <t t-foreach="props.node.children" t-as="child" t-key="child.id">
                            <TreeNode node="child" 
                                      level="childLevel" 
                                      activeNodeId="props.activeNodeId"
                                      activeNodeType="props.activeNodeType"
                                      onSelectNode="props.onSelectNode"
                                      onContextMenu="props.onContextMenu"
                                      onToggleSelect="props.onToggleSelect"
                                      onDragStart="props.onDragStart"
                                      onDragOver="props.onDragOver"
                                      onDrop="props.onDrop"
                                      selectedIds="props.selectedIds"
                                      draggedNode="props.draggedNode"/>
                        </t>
                    </t>
                    
                    <!-- Persons under this org -->
                    <t t-if="props.node.persons">
                        <t t-foreach="props.node.persons" t-as="person" t-key="person.id">
                            <TreeNode node="person" 
                                      level="childLevel" 
                                      activeNodeId="props.activeNodeId"
                                      activeNodeType="props.activeNodeType"
                                      onSelectNode="props.onSelectNode"
                                      onContextMenu="props.onContextMenu"
                                      onToggleSelect="props.onToggleSelect"
                                      onDragStart="props.onDragStart"
                                      onDragOver="props.onDragOver"
                                      onDrop="props.onDrop"
                                      selectedIds="props.selectedIds"
                                      draggedNode="props.draggedNode"/>
                        </t>
                    </t>
                </div>
            </t>
        </div>
    </t>

    <!-- Members Panel Template -->
    <t t-name="myschool_admin.MembersPanel" owl="1">
        <div class="ob-members">
            <div class="ob-members-header">
                <i class="fa fa-users" style="margin-right: 6px;"/>
                Members
            </div>
            <div class="ob-members-content">
                <t t-if="!props.node">
                    <div class="ob-members-empty">
                        <i class="fa fa-info-circle text-muted"/>
                        <span>Select an organization to view members</span>
                    </div>
                </t>
                <t t-elif="props.node.type !== 'org'">
                    <div class="ob-members-empty">
                        <i class="fa fa-info-circle text-muted"/>
                        <span>Members view available for organizations only</span>
                    </div>
                </t>
                <t t-elif="props.loading">
                    <div class="ob-members-loading">
                        <i class="fa fa-spinner fa-spin"/>
                        <span>Loading members...</span>
                    </div>
                </t>
                <t t-else="">
                    <!-- Persons Section -->
                    <div class="ob-members-section">
                        <div class="ob-members-section-header">
                            <i class="fa fa-user"/>
                            Persons
                            <span class="ob-members-count" t-if="props.members?.persons?.length">
                                (<t t-esc="props.members.persons.length"/>)
                            </span>
                        </div>
                        <div class="ob-members-list">
                            <t t-if="props.members?.persons?.length">
                                <t t-foreach="props.members.persons" t-as="person" t-key="person.id">
                                    <div class="ob-member-item" t-on-click="onMemberClick" t-att-data-model="person.model" t-att-data-id="person.id">
                                        <i class="fa fa-user ob-member-icon"/>
                                        <div class="ob-member-info">
                                            <div class="ob-member-name"><t t-esc="person.name"/></div>
                                            <div class="ob-member-detail" t-if="person.email">
                                                <t t-esc="person.email"/>
                                            </div>
                                            <div class="ob-member-roles" t-if="person.roles?.length">
                                                <t t-foreach="person.roles" t-as="role" t-key="role">
                                                    <span class="ob-role-badge"><t t-esc="role"/></span>
                                                </t>
                                            </div>
                                        </div>
                                    </div>
                                </t>
                            </t>
                            <t t-else="">
                                <div class="ob-members-none">No persons in this organization</div>
                            </t>
                        </div>
                    </div>
                    
                    <!-- Person Groups Section -->
                    <div class="ob-members-section">
                        <div class="ob-members-section-header">
                            <i class="fa fa-users"/>
                            Person Groups
                            <span class="ob-members-count" t-if="props.members?.persongroups?.length">
                                (<t t-esc="props.members.persongroups.length"/>)
                            </span>
                        </div>
                        <div class="ob-members-list">
                            <t t-if="props.members?.persongroups?.length">
                                <t t-foreach="props.members.persongroups" t-as="group" t-key="group.id">
                                    <div class="ob-member-item" t-on-click="onMemberClick" t-att-data-model="group.model" t-att-data-id="group.id">
                                        <i class="fa fa-users ob-member-icon ob-member-icon-group"/>
                                        <div class="ob-member-info">
                                            <div class="ob-member-name"><t t-esc="group.name"/></div>
                                            <div class="ob-member-detail" t-if="group.full_name !== group.name">
                                                <t t-esc="group.full_name"/>
                                            </div>
                                        </div>
                                    </div>
                                </t>
                            </t>
                            <t t-else="">
                                <div class="ob-members-none">No person groups</div>
                            </t>
                        </div>
                    </div>
                </t>
            </div>
        </div>
    </t>

    <!-- Details Panel Template -->
    <t t-name="myschool_admin.DetailsPanel" owl="1">
        <div class="ob-details">
            <t t-if="!props.node">
                <div class="ob-details-empty">
                    <i class="fa fa-mouse-pointer fa-2x text-muted"/>
                    <p>Select an item to view details</p>
                </div>
            </t>
            <t t-else="">
                <!-- Header -->
                <div class="ob-details-header">
                    <div class="ob-details-icon">
                        <t t-if="props.node.type === 'org'">
                            <i class="fa fa-building fa-2x text-primary"/>
                        </t>
                        <t t-elif="props.node.type === 'person'">
                            <i class="fa fa-user fa-2x text-info"/>
                        </t>
                    </div>
                    <div class="ob-details-title">
                        <h3><t t-esc="props.node.full_name or props.node.name"/></h3>
                        <span class="ob-details-type">
                            <t t-if="props.node.type === 'org'">Organization</t>
                            <t t-elif="props.node.type === 'person'">Person</t>
                        </span>
                    </div>
                    <button class="ob-btn ob-btn-sm ob-btn-primary" t-on-click="openRecord">
                        <i class="fa fa-external-link"/> Open
                    </button>
                </div>
                
                <!-- Info Cards -->
                <div class="ob-details-content">
                    <t t-if="props.node.type === 'org'">
                        <div class="ob-info-card">
                            <div class="ob-info-label">Short Name</div>
                            <div class="ob-info-value"><t t-esc="props.node.name"/> </div>
                        </div>
                        <t t-if="props.node.child_count">
                            <div class="ob-info-card">
                                <div class="ob-info-label">Sub-organizations</div>
                                <div class="ob-info-value"><t t-esc="props.node.child_count"/></div>
                            </div>
                        </t>
                        <t t-if="props.node.person_count">
                            <div class="ob-info-card">
                                <div class="ob-info-label">Persons</div>
                                <div class="ob-info-value"><t t-esc="props.node.person_count"/></div>
                            </div>
                        </t>
                        <t t-if="props.node.is_administrative">
                            <div class="ob-info-card">
                                <div class="ob-info-label">Type</div>
                                <div class="ob-info-value"><span class="ob-badge ob-badge-admin">Administrative</span></div>
                            </div>
                        </t>
                        
                        <!-- Configuration Items Section -->
                        <t t-if="props.node.ciRelations and props.node.ciRelations.length">
                            <div class="ob-ci-section">
                                <div class="ob-ci-header">
                                    <span><i class="fa fa-sliders"/> Configuration Items</span>
                                    <button class="ob-btn ob-btn-sm" t-on-click="onConfigurationClick">
                                        <i class="fa fa-cog"/>
                                    </button>
                                </div>
                                <div class="ob-ci-list">
                                    <t t-foreach="props.node.ciRelations" t-as="ci" t-key="ci.id">
                                        <div class="ob-ci-item">
                                            <div class="ob-ci-name"><t t-esc="ci.name"/></div>
                                            <div class="ob-ci-value"><t t-esc="ci.value"/></div>
                                            <div class="ob-ci-actions">
                                                <button class="ob-ci-btn" t-on-click="onEditCiClick" t-att-data-ci-id="ci.id" title="Edit">
                                                    <i class="fa fa-pencil"/>
                                                </button>
                                                <button class="ob-ci-btn ob-ci-btn-danger" t-on-click="onRemoveCiClick" t-att-data-ci-id="ci.id" title="Remove">
                                                    <i class="fa fa-times"/>
                                                </button>
                                            </div>
                                        </div>
                                    </t>
                                </div>
                            </div>
                        </t>
                        <t t-elif="props.node.ci_count">
                            <div class="ob-info-card">
                                <div class="ob-info-label">Config Items</div>
                                <div class="ob-info-value">
                                    <t t-esc="props.node.ci_count"/>
                                    <button class="ob-btn ob-btn-sm" style="margin-left: 8px;" t-on-click="onConfigurationClick">
                                        <i class="fa fa-eye"/> View
                                    </button>
                                </div>
                            </div>
                        </t>
                    </t>
                    
                    <t t-if="props.node.type === 'person'">
                        <t t-if="props.node.roles and props.node.roles.length">
                            <div class="ob-info-card">
                                <div class="ob-info-label">Roles</div>
                                <div class="ob-info-value">
                                    <t t-foreach="props.node.roles" t-as="role" t-key="role">
                                        <span class="ob-badge ob-badge-role"><t t-esc="role"/></span>
                                    </t>
                                </div>
                            </div>
                        </t>
                        <t t-if="props.node.is_administrative">
                            <div class="ob-info-card">
                                <div class="ob-info-label">Type</div>
                                <div class="ob-info-value"><span class="ob-badge ob-badge-admin">Administrative</span></div>
                            </div>
                        </t>
                    </t>
                </div>
                
                <!-- Quick Actions -->
                <div class="ob-details-actions">
                    <h4>Quick Actions</h4>
                    <t t-if="props.node.type === 'org'">
                        <button class="ob-action-btn" t-on-click="onCreatePersonClick">
                            <i class="fa fa-user-plus"/> Create Person
                        </button>
                        <button class="ob-action-btn" t-on-click="onAddChildOrgClick">
                            <i class="fa fa-plus-circle"/> Add Sub-Organization
                        </button>
                        <button class="ob-action-btn" t-on-click="onConfigurationClick">
                            <i class="fa fa-sliders"/> Configuration
                        </button>
                        <button class="ob-action-btn" t-on-click="onMoveOrgClick">
                            <i class="fa fa-arrows"/> Move
                        </button>
                    </t>
                    <t t-if="props.node.type === 'person'">
                        <button class="ob-action-btn" t-on-click="onAssignRoleClick">
                            <i class="fa fa-id-badge"/> Assign Role
                        </button>
                        <button class="ob-action-btn" t-on-click="onMovePersonClick">
                            <i class="fa fa-arrows"/> Move to Org
                        </button>
                    </t>
                </div>
            </t>
        </div>
    </t>

    <!-- Main Object Browser Template -->
    <t t-name="myschool_admin.ObjectBrowserClient" owl="1">
        <div class="ob-container" t-ref="container">
            <!-- Header -->
            <div class="ob-header">
                <h2><i class="fa fa-sitemap me-2"/>MySchool Admin</h2>
                <div class="ob-toolbar">
                    <div class="ob-search-wrapper">
                        <i class="fa fa-search ob-search-icon"/>
                        <input type="text" 
                               class="ob-search" 
                               placeholder="Search..." 
                               t-att-value="state.searchText"
                               t-on-input="onSearchInput"/>
                    </div>
                    <label class="ob-checkbox">
                        <input type="checkbox" 
                               t-att-checked="state.showInactive"
                               t-on-change="onToggleInactive"/>
                        Show Inactive
                    </label>
                    <label class="ob-checkbox">
                        <input type="checkbox" 
                               t-att-checked="state.showAdministrative"
                               t-on-change="onToggleAdministrative"/>
                        Show Administrative
                    </label>
                    <button class="ob-btn ob-btn-secondary" t-on-click="toggleSelectionMode">
                        <i t-att-class="state.selectionMode ? 'fa fa-check-square' : 'fa fa-square-o'" style="margin-right: 4px;"/>
                        <t t-if="state.selectionMode">Selection ON</t>
                        <t t-else="">Select</t>
                    </button>
                    <button class="ob-btn ob-btn-primary" t-on-click="onRefresh">
                        <i class="fa fa-refresh" style="margin-right: 4px;"/>
                        Refresh
                    </button>
                </div>
            </div>
            
            <!-- Tabs -->
            <div class="ob-tabs">
                <button t-att-class="'ob-tab' + (state.activeTab === 'orgs' ? ' ob-tab-active' : '')"
                        t-on-click="onSwitchToOrgsTab">
                    <i class="fa fa-building"/> Organisation Manager
                </button>
                <button t-att-class="'ob-tab' + (state.activeTab === 'roles' ? ' ob-tab-active' : '')"
                        t-on-click="onSwitchToRolesTab">
                    <i class="fa fa-id-badge"/> Role Relations Manager
                </button>
            </div>
            
            <!-- Bulk Actions Bar (shown when items selected) -->
            <t t-if="state.selectionMode and selectedCount > 0">
                <div class="ob-bulk-bar">
                    <span class="ob-bulk-count"><t t-esc="selectedCount"/> selected</span>
                    <button class="ob-btn ob-btn-sm" t-on-click="bulkAssignRole">
                        <i class="fa fa-id-badge" style="margin-right: 4px;"/>Assign Role
                    </button>
                    <button class="ob-btn ob-btn-sm" t-on-click="bulkMoveToOrg">
                        <i class="fa fa-arrows" style="margin-right: 4px;"/>Move to Org
                    </button>
                    <button class="ob-btn ob-btn-sm ob-btn-danger" t-on-click="bulkDelete">
                        <i class="fa fa-trash" style="margin-right: 4px;"/>Delete
                    </button>
                    <button class="ob-btn ob-btn-sm" t-on-click="clearSelection">
                        <i class="fa fa-times" style="margin-right: 4px;"/>Clear
                    </button>
                </div>
            </t>
            
            <!-- Drag hint -->
            <t t-if="state.draggedNode">
                <div class="ob-drag-hint">
                    <i class="fa fa-hand-rock-o" style="margin-right: 8px;"/>
                    Dragging: <t t-esc="state.draggedNode.name"/> - Drop on an organization
                </div>
            </t>
            
            <!-- Organisation Manager Tab Content -->
            <t t-if="state.activeTab === 'orgs'">
            <!-- Main Content: Tree + Members + Details -->
            <div class="ob-main">
                <!-- Tree Panel -->
                <div class="ob-tree-panel">
                    <div class="ob-tree-header">
                        <i class="fa fa-folder-open" style="margin-right: 6px;"/>
                        Organizations
                    </div>
                    <div class="ob-tree-content">
                        <!-- Loading -->
                        <t t-if="state.loading">
                            <div class="ob-loading">
                                <i class="fa fa-spinner fa-spin" style="margin-right: 8px;"/>Loading...
                            </div>
                        </t>
                        
                        <t t-elif="state.treeData.organizations.length === 0">
                            <div class="ob-empty">
                                <i class="fa fa-folder-open-o" style="margin-right: 8px;"/>No organizations found
                            </div>
                        </t>
                        
                        <t t-else="">
                            <t t-foreach="state.treeData.organizations" t-as="org" t-key="org.id">
                                <TreeNode node="org" 
                                          level="0" 
                                          activeNodeId="state.activeNode?.id"
                                          activeNodeType="state.activeNode?.type"
                                          onSelectNode="onSelectNode"
                                          onContextMenu="onContextMenu"
                                          onToggleSelect="onToggleSelect"
                                          onDragStart="onDragStart"
                                          onDragOver="onDragOver"
                                          onDrop="onDrop"
                                          selectedIds="state.selectionMode ? state.selectedIds : null"
                                          draggedNode="state.draggedNode"/>
                            </t>
                        </t>
                    </div>
                </div>
                
                <!-- Members Panel -->
                <MembersPanel 
                    node="state.activeNode"
                    members="state.membersData"
                    loading="state.membersLoading"
                    onOpenRecord="openRecord"/>
                
                <!-- Details Panel -->
                <DetailsPanel node="state.activeNode"
                              onAction="onDetailsAction"
                              onOpenRecord="openActiveRecord"
                              onEditCi="openEditCiWizard"
                              onRemoveCi="openRemoveCiWizard"/>
            </div>
            </t>
            
            <!-- Role Relations Manager Tab Content -->
            <t t-if="state.activeTab === 'roles'">
            <div class="ob-role-manager">
                <div class="ob-role-manager-content">
                    <!-- SRBR Section -->
                    <div class="ob-role-section">
                        <div class="ob-role-section-header">
                            <h3><i class="fa fa-exchange"/> SAP-Role to Backend-Role (SRBR)</h3>
                            <p class="text-muted">Link SAP roles to backend roles for role mapping.</p>
                        </div>
                        <div class="ob-role-section-actions">
                            <button class="ob-btn ob-btn-primary" t-on-click="openAddSRBRWizard">
                                <i class="fa fa-plus"/> Add SRBR Relation
                            </button>
                            <button class="ob-btn ob-btn-secondary" t-on-click="viewSRBRRelations">
                                <i class="fa fa-list"/> View All
                            </button>
                        </div>
                    </div>
                    
                    <!-- BRSO Section -->
                    <div class="ob-role-section">
                        <div class="ob-role-section-header">
                            <h3><i class="fa fa-building"/> Backend-Role to School/Department (BRSO)</h3>
                            <p class="text-muted">Determine where persons with a certain role in a school will be created.</p>
                        </div>
                        <div class="ob-role-section-actions">
                            <button class="ob-btn ob-btn-primary" t-on-click="openAddBRSOWizard">
                                <i class="fa fa-plus"/> Add BRSO Relation
                            </button>
                            <button class="ob-btn ob-btn-secondary" t-on-click="viewBRSORelations">
                                <i class="fa fa-list"/> View All
                            </button>
                        </div>
                    </div>
                    
                    <!-- PPBRSO Section -->
                    <div class="ob-role-section">
                        <div class="ob-role-section-header">
                            <h3><i class="fa fa-user-circle"/> Person/Period BRSO (PPBRSO)</h3>
                            <p class="text-muted">Like BRSO but also includes person and period for specific assignments.</p>
                        </div>
                        <div class="ob-role-section-actions">
                            <button class="ob-btn ob-btn-primary" t-on-click="openAddPPBRSOWizard">
                                <i class="fa fa-plus"/> Add PPBRSO Relation
                            </button>
                            <button class="ob-btn ob-btn-secondary" t-on-click="viewPPBRSORelations">
                                <i class="fa fa-list"/> View All
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            </t>
        
            <!-- Context Menu -->
            <t t-if="state.contextMenu">
                <ContextMenu x="state.contextMenu.x"
                             y="state.contextMenu.y"
                             node="state.contextMenu.node"
                             onAction="onContextMenuAction"
                             onClose="onCloseContextMenu"/>
            </t>
        </div>
    </t>

</templates>
